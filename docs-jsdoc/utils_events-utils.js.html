<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>utils/events-utils.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Accounts.html">Accounts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Accounts.html#addAccount">addAccount</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="AmbrosusSDK.html">AmbrosusSDK</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AmbrosusSDK.html#getApiToken">getApiToken</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Assets.html">Assets</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Assets.html#createAsset">createAsset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Assets.html#getAsset">getAsset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Assets.html#getAssets">getAssets</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Blocks.html">Blocks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Blocks.html#getBlock">getBlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Blocks.html#getLatestBlock">getLatestBlock</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Bundles.html">Bundles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bundles.html#getBundle">getBundle</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Contracts.html">Contracts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Contracts.html#loadContract">loadContract</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EventHandler.html">EventHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EventHandler.html#emit">emit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EventHandler.html#off">off</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EventHandler.html#on">on</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Events.html">Events</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Events.html#createEvent">createEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Events.html#createSingleEvent">createSingleEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Events.html#getEvent">getEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Events.html#getEvents">getEvents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Events.html#parseEvents">parseEvents</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Service.html">Service</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#decryptPrivateKey">decryptPrivateKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#encryptPrivateKey">encryptPrivateKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#getAccount">getAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#getAddress">getAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#getPkPair">getPkPair</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#isRPCValid">isRPCValid</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Service.html#sign">sign</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Transactions.html">Transactions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Transactions.html#getBalance">getBalance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Transactions.html#getTransaction">getTransaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Transactions.html#getTransactionCount">getTransactionCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Transactions.html#getTransactionRecepit">getTransactionRecepit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Transactions.html#sendTransaction">sendTransaction</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#base64url">base64url</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#calculateHash">calculateHash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkAccessLevel">checkAccessLevel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkTimeStamp">checkTimeStamp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#findEvent">findEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#fromWei">fromWei</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getImage">getImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getLocation">getLocation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getName">getName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRequest">getRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUrlName">getUrlName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#handleResponse">handleResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#hashMessage">hashMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isAddress">isAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isLatest">isLatest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isObject">isObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseAsset">parseAsset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseEvent">parseEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseEvents">parseEvents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseTimelineEvents">parseTimelineEvents</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#postRequest">postRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#randomHex">randomHex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#rejectResponse">rejectResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#serializeForHashing">serializeForHashing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#serializeParams">serializeParams</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortEventsByTimestamp">sortEventsByTimestamp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#successResponse">successResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#timeSince">timeSince</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toHex">toHex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toWei">toWei</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#utf8Encode">utf8Encode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validTimestamp">validTimestamp</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/events-utils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { timeSince, validTimestamp } from './time-utils';
/**
 * Check the accessLevel of the asset
 *
 * @function checkAccessLevel
 * @param {Object} event
 * @returns {number} accessLevel
 */
export const checkAccessLevel = event => {
    try {
        return event.content.idData.accessLevel;
    } catch (error) {
        return 0;
    }
};

/**
 * Get the Title
 *
 * @function getName
 * @param {Object} obj
 * @param {string} alternative
 * @returns {Object} name
 */
export const getName = (obj, alternative = 'No title') => {
    try {
        const name = obj.name;
        let type = obj.type.split('.');
        type = type[type.length - 1];
        return [name, type].find(i => i);
    } catch (e) {
        return alternative;
    }
};

/**
 * Get image URL from the object
 *
 * @function getImage
 * @param {Object} obj
 * @returns {string} Image URL
 */
export const getImage = (obj) => {
    try {
        return obj.images.default.url;
    } catch (e) {
        return '';
    }
};

/**
 * Get location from the Object
 *
 * @function getLocation
 * @param {Object} event
 * @returns {Object} Location
 */
export const getLocation = (event) => {
    const location = event.location || event;
    const {
        city,
        country,
        name
    } = location;
    return (
        [city, country, name].filter(item => !!item).join(', ') || 'No place attached'
    );
};

/**
 * Sorts the Event by descending order based on the timestamp
 *
 * @function sortEventsByTimestamp
 * @param {Object} objectA Object which contains timestamp property
 * @param {Object} objectB Object which contains timestamp property
 * @returns {Object} Object sorted by descending order based on timestamp
 */
export const sortEventsByTimestamp = (a, b) => {
    if (a.timestamp > b.timestamp) {
        return -1;
    }
    if (a.timestamp &lt; b.timestamp) {
        return 1;
    }
    return 0;
};

/**
 * Parse the Event and create groups/properties array
 *
 * @function parseEvent
 * @param {Object}  event
 * @returns {Object} event
 */
export const parseEvent = (event) => {
    event.info = {};
    event.info['groups'] = [];
    event.info['properties'] = [];

    // Extract event objects
    if (event.content.data &amp;&amp; Array.isArray(event.content.data)) {
        event.content.data.map((obj) => {
            const type = obj.type.split('.');
            obj.type = type[type.length - 1].toLowerCase();

            if (obj.type === 'location' || obj.type === 'identifiers') {
                event.info[obj.type] = obj;
            } else {
                event.info.name = obj.name || obj.type;

                Object.keys(obj).map((key) => {
                    if (['images', 'documents', 'description'].indexOf(key) > -1) {
                        event.info[key] = obj[key];
                    }

                    if (
                        [
                            'type',
                            'name',
                            'assetType',
                            'eventId',
                            'createdBy',
                            'timestamp',
                            'location',
                            'images',
                            'documents',
                            'description',
                            'identifiers',
                            'groups',
                            'properties'
                        ].indexOf(key) === -1
                    ) {
                        const property = {
                            key,
                            value: obj[key]
                        };
                        event.info[typeof property.value === 'string' || Array.isArray(property.value) ? 'properties' : 'groups'].push(property);
                    }
                });
            }
            return obj;
        });
    }
    return event;
};

/**
 * Parse the Asset and create groups/properties Array
 *
 * @function parseAsset
 * @param {Object} asset
 * @returns {Object} asset
 */
export const parseAsset = (asset) => {
    if (!asset.info) {
        asset.info = {};
    }
    asset.info['groups'] = [];
    asset.info['properties'] = [];

    Object.keys(asset.info).map((key) => {
        if (key === 'location' || key === 'identifiers') {
            asset[key] = asset.info[key];
        } else {
            if (
                [
                    'type',
                    'name',
                    'assetType',
                    'images',
                    'eventId',
                    'createdBy',
                    'timestamp',
                    'groups',
                    'properties'
                ].indexOf(key) === -1
            ) {
                const property = {
                    key,
                    value: asset.info[key]
                };
                asset.info[typeof property.value === 'string' || Array.isArray(property.value) ? 'properties' : 'groups'].push(property);
            }
        }
    });
};

/**
 * Parse the timeline events based on Date
 *
 * @function parseTimelineEvents
 * @param {Object} e
 * @returns {Object} parsedEvents.
 */
export const parseTimelineEvents = (e) => {
    const events = e.reduce((_events, {
        content,
        eventId
    }) => {
        const timestamp = content.idData.timestamp;
        const createdBy = content.idData.createdBy;

        if (content &amp;&amp; content.data) {
            content.data.map(obj => {
                const parts = obj.type.split('.');
                const type = parts[parts.length - 1];
                const category = parts[parts.length - 2] || 'asset';
                const ago = timeSince(timestamp * 1000);

                obj.timestamp = timestamp;
                obj.createdBy = createdBy;
                obj.name = obj.name || type;
                obj.type = type;
                obj.eventId = eventId;
                obj.ago = ago;

                if (obj.type === 'location' &amp;&amp; category === 'event') {
                    content.data.reduce((location, _event) => {
                        if (_event.type !== 'location') {
                            _event.location = location;
                        }
                    }, obj);
                }

                const notInclude = ['location', 'identifier', 'identifiers'];
                if (notInclude.indexOf(obj.type) === -1) {
                    _events.push(obj);
                }

                return obj;
            });
        }
        return _events;
    }, []);
    events.sort(sortEventsByTimestamp);
    return events;
};

/**
 * Check whether the event is latest
 *
 * @function isLatest
 * @param {string} type
 * @returns {boolean}
 */
export const isLatest = (type) => {
    return (['info', 'redirection', 'identifiers', 'branding', 'location'].indexOf(type) === -1);
};

/**
 * Finds a signle event from the events object
 *
 * @function findEvent
 * @param {string} eventType
 * @param {Object} events
 * @returns {Object} event
 */
export const findEvent = (eventType, events) => {
    let e = false;
    events.map(event => {
        if (event.content.data) {
            event.content.data.map(obj => {
                const type = obj.type.split('.');
                obj.type = type[type.length - 1];
                obj.type = obj.type.toLowerCase();

                if (obj.type === 'location' || obj.type === 'identifiers') {
                    event.content.data.map(_obj => {
                        if (['location', 'identifiers'].indexOf(_obj.type) === -1) {
                            _obj[obj.type === 'location' ? 'location' : 'identifiers'] = obj;
                        }
                    });
                }
                switch (eventType) {
                    case 'latest':
                        if (isLatest(obj.type)) {
                            e = obj;
                        }
                        break;
                    default:
                        if (obj.type === eventType) {
                            e = obj;
                        }
                }
                return obj;
            });
        }

        return event;
    });

    return e;
};

/**
 * Check if timestamp exists
 *
 * @function checkTimeStamp
 * @param {Object} event
 * @returns {number} timestamp
 */
export const checkTimeStamp = event => {
    let timestamp = Math.floor(Date.now() / 1000);

    return event.content &amp;&amp; event.content.idData &amp;&amp; event.content.idData.timestamp &amp;&amp; validTimestamp(event.content.idData.timestamp) ? event.content.idData.timestamp : timestamp;
};

/**
 * Parse all events
 *
 * @function parseEvents
 * @param {Array.&lt;Object>} eventsArray
 * @returns {Object} events
 */
export const parseEvents = eventsArray => {
    return eventsArray.results.reduce(
        (asset, {
            content,
            eventId
        }) => {
            const timestamp = content.idData.timestamp;
            const author = content.idData.createdBy;

            if (content &amp;&amp; content.data) {
                content.data
                    .filter(obj => {
                        const parts = obj.type.split('.');
                        const type = parts[parts.length - 1];
                        const category = parts[parts.length - 2] || 'asset';
                        obj.timestamp = timestamp;
                        obj.author = author;
                        obj.name = obj.name || type;
                        obj.action = type;
                        obj.type = type;
                        obj.eventId = eventId;

                        if ((obj.type === 'location' || obj.type === 'identifiers') &amp;&amp; category === 'event') {
                            content.data.reduce((_obj, _event) => {
                                if (obj.type === 'location' &amp;&amp; _event.type !== 'location') {
                                    _event.location = _obj;
                                }
                                if (obj.type === 'identifiers' &amp;&amp; _event.type !== 'identifiers') {
                                    _event.identifiers = _obj;
                                }
                                return _obj;
                            }, obj);
                        } else {
                            return obj;
                        }
                    })
                    .map(event => {
                        if (['info', 'redirection', 'identifiers', 'branding'].indexOf(event.type) > -1) {
                            if (!asset[event.type] || asset[event.type].timestamp &lt; event.timestamp) {
                                asset[event.type] = event;
                            }
                        } else {
                            asset.events.push(event);
                        }
                    });
            }
            return asset;
        }, {
            events: []
        }
    );
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Apr 05 2019 10:15:42 GMT+0300 (EEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
