"use strict";var classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),inherits=function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},possibleConstructorReturn=function(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a},Response=function(){function a(){classCallCheck(this,a)}return createClass(a,[{key:"handleResponse",value:function(a){return new Promise(function(b,c){var d={status:a.status,data:null,message:JSON.parse(a.response).reason};return 200===a.status||201===a.status?(d.data=JSON.parse(a.response),d.message="success",b(d)):c(d)})}},{key:"rejectResponse",value:function(a){return{status:400,data:null,message:a}}}]),a}(),Assets=function(a){function b(a,c){classCallCheck(this,b);var d=possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d._settings=a,c.getToken().then(function(a){d._settings.token=a}),d}return inherits(b,a),createClass(b,[{key:"getAssetById",value:function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest;e.open("GET",b._settings.apiEndpoint+"/assets/"+a,!0),e.addEventListener("load",function(){b.handleResponse(e).then(function(a){c(a)}).catch(function(a){d(a)})},!1),e.send()})}},{key:"createAsset",value:function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest;e.open("POST",b._settings.apiEndpoint+"/assets",!0),e.setRequestHeader("Content-type","application/json; charset=utf-8"),e.setRequestHeader("Authorization","AMB "+b._settings.secret),e.onload=function(){b.handleResponse(e).then(function(a){c(a)}).catch(function(a){d(a)})},e.send(JSON.stringify(a))})}}]),b}(Response),Events=function(a){function b(a,c){classCallCheck(this,b);var d=possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d._settings=a,c.getToken().then(function(a){d._settings.token=a}),d}return inherits(b,a),createClass(b,[{key:"getEventById",value:function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest;e.open("GET",b._settings.apiEndpoint+"/events/"+a,!0),e.addEventListener("load",function(){b.handleResponse(e).then(function(a){c(a)}).catch(function(a){d(a)})},!1),e.send()})}},{key:"getEvents",value:function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest,f="";for(var g in a)""!=f&&(f+="&"),f+=g+"="+encodeURIComponent(a[g]);e.open("GET",b._settings.apiEndpoint+"/events?"+f,!0),e.addEventListener("load",function(){b.handleResponse(e).then(function(a){c(a)}).catch(function(a){d(a)})},!1),e.send()})}},{key:"createEvent",value:function(a,b){var c=this;return new Promise(function(d,e){var f=new XMLHttpRequest;f.open("POST",c._settings.apiEndpoint+"/assets/"+a+"/events",!0),f.setRequestHeader("Content-type","application/json; charset=utf-8"),f.setRequestHeader("Authorization","AMB "+c._settings.secret),f.onload=function(){c.handleResponse(f).then(function(a){d(a)}).catch(function(a){e(a)})},f.send(JSON.stringify(b))})}}]),b}(Response),Auth=function(){function a(b){classCallCheck(this,a),this._settings=b}return createClass(a,[{key:"getToken",value:function(){var a=this;return new Promise(function(b){if(a._settings.token)b(a._settings.token);else{var c=new XMLHttpRequest;c.open("POST",a._settings.apiEndpoint+"/token",!0),c.setRequestHeader("Content-type","application/json; charset=utf-8"),c.setRequestHeader("Authorization","AMB "+a._settings.secret),c.onload=function(){a._settings.token=JSON.parse(c.responseText),b(a._settings.token)},c.send(JSON.stringify({validUntil:16e8}))}})}}]),a}(),AmbrosusSDK=function(){function a(b){if(classCallCheck(this,a),this._settings={apiEndpoint:"https://gateway-test.ambrosus.com"},this.events={},this.empty=[],!b||!b.secret||!b.address)return console.error("API init values are missing"),!1;if(!b.token&&!b.secret||!b.address)return console.error("Secret key and account address are required in order to generate an access token."),!1;for(var c in b)b.hasOwnProperty(c)&&(this._settings[c]=b[c]);this._auth=new Auth(this._settings),this._assets=new Assets(this._settings,this._auth),this._events=new Events(this._settings,this._auth)}return createClass(a,[{key:"getAssetById",value:function(a){var b=this;return new Promise(function(c,d){return a?b._assets.getAssetById(a).then(function(a){c(a)}).catch(function(a){d(a)}):d(b.rejectResponse("Asset ID is missing."))})}},{key:"getEventById",value:function(a){var b=this;return new Promise(function(c,d){return a?b._events.getEventById(a).then(function(a){c(a)}).catch(function(a){d(a)}):d(b.rejectResponse("Event ID is missing."))})}},{key:"getEvents",value:function(a){var b=this;return new Promise(function(c,d){return b._events.getEvents(a).then(function(a){c(a)}).catch(function(a){d(a)})})}},{key:"createAsset",value:function(a){var b=this;return new Promise(function(c,d){if(!a)return d(b.rejectResponse("Asset data is missing."));var e={content:{idData:{createdBy:b._settings.address,timestamp:b.checkTimeStamp(a),sequenceNumber:0}}};return a.data&&(e.data=a.data),b._assets.createAsset(e).then(function(d){if(1<=a.length){for(var e=[],f=function(c){e[c]=new Promise(function(e){return b.createEvent(d.assetId,a[c]).then(function(a){e(a)})})},g=0;g<a.length;g++)f(g);c(d)}c(d)}).catch(function(a){d(a)})})}},{key:"createEvent",value:function(a,b){var c=this;return new Promise(function(d,e){if(!a)return e(c.rejectResponse("Asset ID is missing."));if(!b)return e(c.rejectResponse("Event data is missing."));var f={content:{idData:{assetId:a,timestamp:c.checkTimeStamp(b),accessLevel:0,createdBy:c._settings.address}}};if(b.content&&b.content.data)f.content.data=b.content.data;else return e(c.rejectResponse("Invalid data: No content found at content.data."));return c._events.createEvent(a,f).then(function(a){d(a)}).catch(function(a){e(a)})})}},{key:"checkTimeStamp",value:function(a){var b=Math.floor(Date.now()/1e3);return a.content&&a.content.idData&&a.content.idData.timestamp?a.content.idData.timestamp:b}},{key:"on",value:function(a,b,c){return(this.events[a]=this.events[a]||[]).push([b,c]),this}},{key:"off",value:function(a,b){a||(this.events={});for(var c=this.events[a]||this.empty,d=c.length=b?c.length:0;d--;)b===c[d][0]&&c.splice(d,1);return this}},{key:"emit",value:function(a){for(var b=this.events[a]||this.empty,c=0<b.length?b.slice(0,b.length):b,d=0,e=void 0;e=c[d++];)e[0].apply(e[1],this.empty.slice.call(arguments,1));return this}},{key:"rejectResponse",value:function(a){return{status:400,data:null,message:a}}}]),a}();module.exports=AmbrosusSDK;
