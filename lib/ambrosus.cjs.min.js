/**
 * MIT License
 *
 * Copyright (c) 2018 Ambrosus
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/* Ambrosus Javascript SDK v0.7.3 */'use strict';var handleResponse=function(a){return new Promise(function(b,c){var d={status:a.status,data:null,message:JSON.parse(a.response).reason};(200===a.status||201===a.status)&&(d.data=JSON.parse(a.response),d.message='success',b(d)),c(d)})},rejectResponse=function(a){return{status:400,data:null,message:a}},successResponse=function(a){return{status:200,data:a,message:'success'}},Request=function(a){this._settings=a};Request.prototype.getRequest=function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest;e.open('GET',b._settings.apiEndpoint+'/'+a,!0),e.addEventListener('load',function(){handleResponse(e).then(function(a){return c(a)}).catch(function(a){return d(a)})},!1),e.send()})},Request.prototype.postRequest=function(a,b){var c=this;return new Promise(function(d,e){if(!c._settings||!c._settings.secret||!c._settings.address)return e({status:400,data:null,message:'Secret key and account address are required for a state-modifying call'});var f=new XMLHttpRequest;f.open('POST',c._settings.apiEndpoint+'/'+a,!0,c._settings),f.setRequestHeader('Content-type','application/json; charset=utf-8'),f.setRequestHeader('Authorization','AMB '+c._settings.secret),f.onload=function(){handleResponse(f).then(function(a){return d(a)}).catch(function(a){return e(a)})},f.send(JSON.stringify(b))})};var checkTimeStamp=function(a){var b=Math.floor(Date.now()/1e3);return a.content&&a.content.idData&&a.content.idData.timestamp?a.content.idData.timestamp:b},parseEvents=function(a){return a.results.reduce(function(a,b){var c=b.content,d=b.eventId,e=c.idData.timestamp,f=c.idData.createdBy;return c&&c.data&&c.data.filter(function(a){var b=a.type.split('.'),g=b[b.length-1],h=b[b.length-2]||'asset',i=b[b.length-3]||'ambrosus';return a.timestamp=e,a.author=f,a.name=a.name||g,a.action=g,a.type=g,a.eventId=d,'location'===a.type&&'event'===h?void c.data.reduce(function(a,b){'location'!==b.type&&(b.location=a)},a):a}).map(function(b){-1<['info','redirection','identifiers','branding'].indexOf(b.type)?(!a[b.type]||a[b.type].timestamp<b.timestamp)&&(a[b.type]=b):a.events.push(b)}),a},{events:[]})},serializeParams=function(a){var b='';for(var c in a)''!=b&&(b+='&'),b+=c+'='+encodeURIComponent(a[c]);return b},Assets=function(a){this._settings=a,this._request=new Request(this._settings)};Assets.prototype.getAssetById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},Assets.prototype.getAssets=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets?'+serializeParams(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},Assets.prototype.createAsset=function(a){var b=this;return new Promise(function(c,d){b._request.postRequest('assets',a).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var Events=function(a){this._settings=a,this._request=new Request(this._settings)};Events.prototype.getEventById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},Events.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events?'+serializeParams(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},Events.prototype.createEvent=function(a,b){var c=this;return new Promise(function(d,e){c._request.postRequest('assets/'+a+'/events',b).then(function(a){return d(a)}).catch(function(a){return e(a)})})},Events.prototype.getBundleById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('bundle/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var Auth=function(a){this._settings=a,this._request=new Request(this._settings)};Auth.prototype.getToken=function(a){var b=this;return new Promise(function(c,d){b._request.postRequest('token',a).then(function(a){c(a)}).catch(function(a){return d(a)})})};var assetSequenceNumber=0,AmbrosusSDK=function(a){var b=this;for(var c in this._settings={apiEndpoint:'https://gateway-test.ambrosus.com'},this.events={},this.empty=[],a)a.hasOwnProperty(c)&&(b._settings[c]=a[c]);this._auth=new Auth(this._settings),this._assets=new Assets(this._settings,this._auth),this._events=new Events(this._settings,this._auth)};AmbrosusSDK.prototype.getAssetById=function(a){var b=this;return new Promise(function(c,d){return a?b._assets.getAssetById(a).then(function(a){return c(a)}).catch(function(a){return d(a)}):d(rejectResponse('Asset ID is missing.'))})},AmbrosusSDK.prototype.getEventById=function(a){var b=this;return new Promise(function(c,d){return a?b._events.getEventById(a).then(function(a){return c(a)}).catch(function(a){return d(a)}):d(rejectResponse('Event ID is missing.'))})},AmbrosusSDK.prototype.getAssets=function(a){var b=this;return void 0===a&&(a={}),new Promise(function(c,d){return b._assets.getAssets(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},AmbrosusSDK.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){return b._events.getEvents(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},AmbrosusSDK.prototype.createAsset=function(a){var b=this;return void 0===a&&(a={}),new Promise(function(c,d){var e={content:{idData:{createdBy:b._settings.address,timestamp:checkTimeStamp(a),sequenceNumber:assetSequenceNumber=(assetSequenceNumber+1)%1e6}}};return b._assets.createAsset(e).then(function(d){if(1<=a.length){for(var e=[],f=function(c){e[c]=new Promise(function(e){return b.createEvent(d.data.assetId,a[c]).then(function(a){e(a)})})},g=0;g<a.length;g++)f(g);b.emit('asset:created'),c(d)}else return b.emit('asset:created'),void c(d)}).catch(function(a){return d(a)})})},AmbrosusSDK.prototype.createEvent=function(a,b){var c=this;return new Promise(function(d,e){if(!a)return e(rejectResponse('Asset ID is missing.'));if(!b)return e(rejectResponse('Event data is missing.'));var f={content:{idData:{assetId:a,timestamp:checkTimeStamp(b),accessLevel:0,createdBy:c._settings.address}}};if(b.content&&b.content.data)f.content.data=b.content.data;else return e(rejectResponse('Invalid data: No content found at content.data.'));return c._events.createEvent(a,f).then(function(a){c.emit('event:created'),d(a)}).catch(function(a){return e(a)})})},AmbrosusSDK.prototype.parseEvents=function(a){return new Promise(function(b,c){return a&&a.results?b(successResponse(parseEvents(a))):c(rejectResponse('Results array is missing.'))})},AmbrosusSDK.prototype.getToken=function(a){var b=this;return new Promise(function(c,d){return a||a.validUntil?void b._auth.getToken(a).then(function(a){return c(a)}).catch(function(a){return d(a)}):d(rejectResponse('Invalid data: Unix timestamp was not provided or has an invalid format'))})},AmbrosusSDK.prototype.getBundleById=function(a){var b=this;return new Promise(function(c,d){return a?b._events.getBundleById(a).then(function(a){return c(a)}).catch(function(a){return d(a)}):d(rejectResponse('Bundle ID is missing.'))})},AmbrosusSDK.prototype.on=function(a,b,c){return(this.events[a]=this.events[a]||[]).push([b,c]),this},AmbrosusSDK.prototype.off=function(a,b){a||(this.events={});for(var c=this.events[a]||this.empty,d=c.length=b?c.length:0;d--;)b===c[d][0]&&c.splice(d,1);return this},AmbrosusSDK.prototype.emit=function(a){for(var b,c=arguments,d=this,f=this.events[a]||this.empty,e=0<f.length?f.slice(0,f.length):f,g=0;b=e[g++];)b[0].apply(b[1],d.empty.slice.call(c,1));return this},module.exports=AmbrosusSDK;
//# sourceMappingURL=ambrosus.cjs.min.js.map
