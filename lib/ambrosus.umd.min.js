/**
 * MIT License
 *
 * Copyright (c) 2018 Ambrosus
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/* Ambrosus Javascript SDK v0.11.4 */(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.AmbrosusSDK=b()})(this,function(){'use strict';var a=Math.floor,b=function(a){return new Promise(function(b,c){var d={status:a.status,data:null,message:JSON.parse(a.response).reason};(200===a.status||201===a.status)&&(d.data=JSON.parse(a.response),d.message='success',b(d)),c(d)})},c=function(a){return{status:400,data:null,message:a}},d=function(a){return{status:200,data:a,message:'success'}},e=function(a){this._settings=a};e.prototype.getRequest=function(a){var c=this;return new Promise(function(d,e){var f=new XMLHttpRequest;if(f.open('GET',c._settings.apiEndpoint+'/'+a,!0),c._settings.headers)for(var g in c._settings.headers)f.setRequestHeader(''+g,''+c._settings.headers[g]);f.addEventListener('load',function(){b(f).then(function(a){return d(a)}).catch(function(a){return e(a)})},!1),f.send()})},e.prototype.postRequest=function(a,c,d){var e=this;return void 0===d&&(d=!1),new Promise(function(f,g){var h=new XMLHttpRequest;if(h.open('POST',e._settings.apiEndpoint+'/'+a,!0,e._settings),h.setRequestHeader('Content-type','application/json; charset=utf-8'),e._settings.headers&&!0===d)for(var i in e._settings.headers)h.setRequestHeader(''+i,''+e._settings.headers[i]);h.onload=function(){b(h).then(function(a){return f(a)}).catch(function(a){return g(a)})},h.send(JSON.stringify(c))})};var f=function(b){try{var c=a((+new Date-b)/1e3),d=a(c/31536e3);return 1<=d?d+' year'+(1<d?'s':''):(d=a(c/2592e3),1<=d)?d+' month'+(1<d?'s':''):(d=a(c/86400),1<=d)?d+' day'+(1<d?'s':''):(d=a(c/3600),1<=d)?d+' hour'+(1<d?'s':''):(d=a(c/60),1<=d)?d+' minute'+(1<d?'s':''):(c=1>c?1:c,a(c)+' second'+(1===c?'':'s'))}catch(a){return''}},g=function(a){return 0<new Date(a).getTime()},h=function(b){var c=a(Date.now()/1e3);return b.content&&b.content.idData&&b.content.idData.timestamp&&g(b.content.idData.timestamp)?b.content.idData.timestamp:c},i=function(a){return a.results.reduce(function(a,b){var c=b.content,d=b.eventId,e=c.idData.timestamp,f=c.idData.createdBy;return c&&c.data&&c.data.filter(function(a){var b=a.type.split('.'),g=b[b.length-1],h=b[b.length-2]||'asset',i=b[b.length-3]||'ambrosus';return a.timestamp=e,a.author=f,a.name=a.name||g,a.action=g,a.type=g,a.eventId=d,('location'===a.type||'identifiers'===a.type)&&'event'===h?void c.data.reduce(function(b,c){return'location'===a.type&&'location'!==c.type&&(c.location=b),'identifiers'===a.type&&'identifiers'!==c.type&&(c.identifiers=b),b},a):a}).map(function(b){-1<['info','redirection','identifiers','branding'].indexOf(b.type)?(!a[b.type]||a[b.type].timestamp<b.timestamp)&&(a[b.type]=b):a.events.push(b)}),a},{events:[]})},j=function(a){var b='';for(var c in a)''!=b&&(b+='&'),b+=c+'='+encodeURIComponent(a[c]);return b},k=function(a){if(function(a){return'object'==typeof a&&!Array.isArray(a)}(a)){var b=Object.keys(a).sort().map(function(b){return'"'+b+'":'+k(a[b])}).join(',');return'{'+b+'}'}if(function(a){return Array.isArray(a)}(a)){var c=a.map(function(a){return k(a)}).join(',');return'['+c+']'}return function(a){return'string'==typeof a}(a)?'"'+a+'"':a.toString()},l=function(a){var b=String.fromCharCode;a=a.replace(/\r\n/g,'\n');for(var d,e='',f=0;f<a.length;f++)d=a.charCodeAt(f),128>d?e+=b(d):127<d&&2048>d?(e+=b(192|d>>6),e+=b(128|63&d)):(e+=b(224|d>>12),e+=b(128|63&d>>6),e+=b(128|63&d));return e},m=function(a){var b,c,d,e,f,g,h,j='',k=0;for(a=l(a);k<a.length;)b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),j=j+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(e)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(f)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(g)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(h);return j},n=function(a){try{return a.content.idData.accessLevel}catch(a){return 0}},o=function(c,a){return c.timestamp>a.timestamp?-1:c.timestamp<a.timestamp?1:0},p=function(a){return-1===['info','redirection','identifiers','branding','location'].indexOf(a)},q={validTimestamp:g,checkTimeStamp:h,parseEvents:i,serializeParams:j,serializeForHashing:k,utf8Encode:l,base64url:m,checkAccessLevel:n,getImage:function(a){try{return a.images.default.url}catch(a){return''}},getLocation:function(a){var b=a.location||a,c=b.city,d=b.country,e=b.name;return[c,d,e].filter(function(a){return!!a}).join(', ')||'No place attached'},getName:function(a,b){void 0===b&&(b='No title');try{var c=a.name,d=a.type.split('.');return d=d[d.length-1],[c,d].find(function(a){return a})}catch(a){return b}},getUrlName:function(a){var b=a.split('/');return b=b[b.length-1],b},sortEventsByTimestamp:o,parseAsset:function(a){a.info||(a.info={}),a.info.groups=[],a.info.properties=[],Object.keys(a.info).map(function(b){if('location'===b||'identifiers'===b)a[b]=a.info[b];else if(-1===['type','name','assetType','images','eventId','createdBy','timestamp','groups','properties'].indexOf(b)){var c={key:b,value:a.info[b]};a.info['string'==typeof c.value||Array.isArray(c.value)?'properties':'groups'].push(c)}})},parseEvent:function(a){return a.info={},a.info.groups=[],a.info.properties=[],a.content.data&&Array.isArray(a.content.data)&&a.content.data.map(function(b){var c=b.type.split('.');return b.type=c[c.length-1].toLowerCase(),'location'===b.type||'identifiers'===b.type?a.info[b.type]=b:(a.info.name=b.name||b.type,Object.keys(b).map(function(c){if(-1<['images','documents','description'].indexOf(c)&&(a.info[c]=b[c]),-1===['type','name','assetType','eventId','createdBy','timestamp','location','images','documents','description','identifiers','groups','properties'].indexOf(c)){var d={key:c,value:b[c]};a.info['string'==typeof d.value||Array.isArray(d.value)?'properties':'groups'].push(d)}})),b}),a},isLatest:p,findEvent:function(a,b){var c=!1;return b.map(function(b){return b.content.data&&b.content.data.map(function(d){var e=d.type.split('.');return d.type=e[e.length-1],d.type=d.type.toLowerCase(),('location'===d.type||'identifiers'===d.type)&&b.content.data.map(function(a){-1===['location','identifiers'].indexOf(a.type)&&(a['location'===d.type?'location':'identifiers']=d)}),('latest'===a?p(d.type)&&(c=d):d.type===a&&(c=d),d)}),b}),c},parseTimelineEvents:function(a){var b=a.reduce(function(a,b){var c=b.content,d=b.eventId,e=c.idData.timestamp,g=c.idData.createdBy;return c&&c.data&&c.data.map(function(b){var h=b.type.split('.'),i=h[h.length-1],j=h[h.length-2]||'asset',k=h[h.length-3]||'ambrosus',l=f(1e3*e);b.timestamp=e,b.createdBy=g,b.name=b.name||i,b.type=i,b.eventId=d,b.ago=l,'location'===b.type&&'event'===j&&c.data.reduce(function(a,b){'location'!==b.type&&(b.location=a)},b);return-1===['location','identifier','identifiers'].indexOf(b.type)&&a.push(b),b}),a},[]);return b.sort(o),b},timeSince:f},r=function(a){this._settings=a,this._request=new e(this._settings)};r.prototype.getAssetById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},r.prototype.getAssets=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets?'+j(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},r.prototype.createAsset=function(a){var b=this;return new Promise(function(c,d){b._request.postRequest('assets',a).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var s=function(a){this._settings=a,this._request=new e(this._settings)};s.prototype.getEventById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},s.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events?'+j(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},s.prototype.createEvent=function(a,b){var c=this;return new Promise(function(d,e){c._request.postRequest('assets/'+a+'/events',b).then(function(a){return d(a)}).catch(function(a){return e(a)})})},s.prototype.getBundleById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('bundle/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var t=function(a){this._settings=a,this._request=new e(this._settings)};t.prototype.addAccount=function(a){var b=this;return new Promise(function(c,d){b._request.postRequest('accounts',a,!0).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var u=0,v=function(a){var b=this;if(void 0===a&&(a={}),this.utils=q,this._settings={apiEndpoint:'https://gateway-test.ambrosus.com'},this.events={},this.empty=[],'object'==typeof a){for(var d in a)a.hasOwnProperty(d)&&(b._settings[d]=a[d]);this._settings.Web3&&this._settings.secret?(this.web3=new this._settings.Web3,this.web3.version.api?console.log('Old version of web3 is not supported, Please import v1.0.0+'):(this._settings.address=this.getAddress(this._settings.secret),this._settings.token=this.getToken(this._settings.secret))):this._settings.Web3&&(this.web3=new this._settings.Web3)}else return c('SDK Init parameters should be an object');this._assets=new r(this._settings),this._events=new s(this._settings),this._accounts=new t(this._settings)};return v.prototype.calculateHash=function(a){return this.web3?this.web3.eth.accounts.hashMessage(k(a)):c('web3.js Library is required get the token')},v.prototype.getToken=function(b,d){if(void 0===b&&(b=null),!this.web3)return c('web3.js Library is required get the token');if(!b){if(!this._settings.secret)return c('Secret key is required generate the token');b=this._settings.secret}var e={createdBy:this.getAddress(b),validUntil:d?d:a(Date.now()/1e3)+300};return m(k({signature:this.sign(e,b),idData:e}))},v.prototype.getAddress=function(a){if(void 0===a&&(a=null),!this.web3)return c('web3.js Library is required get the address');if(!a){if(!this._settings.secret)return c('Secret key is required generate the address');a=this._settings.secret}return this.web3.eth.accounts.privateKeyToAccount(a).address},v.prototype.sign=function(a,b){if(void 0===a&&(a={}),void 0===b&&(b=null),!this.web3)return c('web3.js Library is required generate a signature');if(!b){if(!this._settings.secret)return c('Secret key is required generate a signature');b=this._settings.secret}return this.web3.eth.accounts.sign(k(a),b).signature},v.prototype.getPkPair=function(){return this.web3?this.web3.eth.accounts.create(this.web3.utils.randomHex(32)):c('web3.js Library is required generate the publicKey / privateKey pair')},v.prototype.getAssetById=function(a){var b=this;return new Promise(function(d,e){return a?b._assets.getAssetById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(c('Asset ID is missing.'))})},v.prototype.getEventById=function(a){var b=this;return new Promise(function(d,e){return a?b._events.getEventById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(c('Event ID is missing.'))})},v.prototype.getAssets=function(a){var b=this;return void 0===a&&(a={}),new Promise(function(c,d){return b._assets.getAssets(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},v.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){return b._events.getEvents(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},v.prototype.createAsset=function(a){var b=this;return void 0===a&&(a={}),new Promise(function(d,e){var f={};if('object'!=typeof a)return e(c('asset should be a json object or empty'));if(!b.web3)return e(c('web3.js library is required to create an asset'));if(!b._settings.secret)return e(c('Secret missing: Please initialize the SDK with your secret key'));f={timestamp:h(a),sequenceNumber:u=(u+1)%1e6,createdBy:b._settings.address},a&&a.content&&a.content.data&&(f.dataHash=b.web3.eth.accounts.hashMessage(k(a.content.data)));var g={content:{idData:f,signature:b.sign(f,b._settings.secret)}};return g.content&&g.content.idData&&g.content.idData.dataHash&&(g.content.data=a.content.data),b._assets.createAsset(g).then(function(c){return 1<=a.length?void(a.map(function(a){return b.createEvent(c.data.assetId,a).then(function(a){return d(a)}).catch(function(a){return e(a)})}),b.emit('asset:created'),d(c)):(b.emit('asset:created'),void d(c))}).catch(function(a){return e(a)})})},v.prototype.createEvent=function(a,b){var d=this;return new Promise(function(e,f){if('object'!=typeof b)return f(c('event should be a json object'));if(!d.web3)return f(c('web3.js library is required to create an event'));if(!d._settings.secret)return f(c('Secret missing: Please initialize the SDK with your secret key'));if(!a)return f(c('Asset ID is missing.'));if(!b)return f(c('Event data is missing.'));var g={};if(b.content&&b.content.data){var i={assetId:a,timestamp:h(b),accessLevel:n(b),createdBy:d._settings.address,dataHash:d.web3.eth.accounts.hashMessage(k(b.content.data))};g={content:{idData:i,signature:d.sign(i,d._settings.secret),data:b.content.data}}}else return f(c('Invalid data: No content found at content.data.'));return d._events.createEvent(a,g).then(function(a){d.emit('event:created'),e(a)}).catch(function(a){return f(a)})})},v.prototype.parseEvents=function(a){return new Promise(function(b,e){return a&&a.results?b(d(i(a))):e(c('Results array is missing.'))})},v.prototype.getBundleById=function(a){var b=this;return new Promise(function(d,e){return a?b._events.getBundleById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(c('Bundle ID is missing.'))})},v.prototype.addAccount=function(a){var b=this;return new Promise(function(d,e){return b._settings.secret?a?(b.setTokenHeader(b._settings.secret),b._accounts.addAccount(a).then(function(a){return d(a)}).catch(function(a){return e(a)})):e(c('Create account params are required to create an account.')):e(c('Secret key is required to add an account.'))})},v.prototype.setTokenHeader=function(a){if(void 0===a&&(a=null),!this.web3)return c('web3.js Library is required set the token');if(!a){if(!this._settings.secret)return c('Secret key is required set the token');a=this._settings.secret}this._settings.headers={Authorization:'AMB_TOKEN '+this.getToken(a)}},v.prototype.on=function(a,b,c){return(this.events[a]=this.events[a]||[]).push([b,c]),this},v.prototype.off=function(a,b){a||(this.events={});for(var c=this.events[a]||this.empty,d=c.length=b?c.length:0;d--;)b===c[d][0]&&c.splice(d,1);return this},v.prototype.emit=function(a){for(var b,c=arguments,d=this,f=this.events[a]||this.empty,e=0<f.length?f.slice(0,f.length):f,g=0;b=e[g++];)b[0].apply(b[1],d.empty.slice.call(c,1));return this},v});
//# sourceMappingURL=ambrosus.umd.min.js.map
