/**
 * MIT License
 *
 * Copyright (c) 2018 Ambrosus
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/* Ambrosus Javascript SDK v0.7.3 */var AmbrosusSDK=function(){'use strict';var a=function(a){return new Promise(function(b,c){var d={status:a.status,data:null,message:JSON.parse(a.response).reason};(200===a.status||201===a.status)&&(d.data=JSON.parse(a.response),d.message='success',b(d)),c(d)})},b=function(a){return{status:400,data:null,message:a}},c=function(a){return{status:200,data:a,message:'success'}},d=function(a){this._settings=a};d.prototype.getRequest=function(b){var c=this;return new Promise(function(d,e){var f=new XMLHttpRequest;if(f.open('GET',c._settings.apiEndpoint+'/'+b,!0),c._settings.headers)for(var g in c._settings.headers)f.setRequestHeader(''+g,''+c._settings.headers[g]),console.log(''+g,''+c._settings.headers[g]);f.addEventListener('load',function(){a(f).then(function(a){return d(a)}).catch(function(a){return e(a)})},!1),f.send()})},d.prototype.postRequest=function(b,c){var d=this;return new Promise(function(e,f){var g=new XMLHttpRequest;g.open('POST',d._settings.apiEndpoint+'/'+b,!0,d._settings),g.setRequestHeader('Content-type','application/json; charset=utf-8'),g.onload=function(){a(g).then(function(a){return e(a)}).catch(function(a){return f(a)})},g.send(JSON.stringify(c))})};var e=function(a){return 0<new Date(a).getTime()},f=function(a){var b=Math.floor(Date.now()/1e3);return a.content&&a.content.idData&&a.content.idData.timestamp&&e(a.content.idData.timestamp)?a.content.idData.timestamp:b},g=function(a){return a.results.reduce(function(a,b){var c=b.content,d=b.eventId,e=c.idData.timestamp,f=c.idData.createdBy;return c&&c.data&&c.data.filter(function(a){var b=a.type.split('.'),g=b[b.length-1],h=b[b.length-2]||'asset',i=b[b.length-3]||'ambrosus';return a.timestamp=e,a.author=f,a.name=a.name||g,a.action=g,a.type=g,a.eventId=d,'location'===a.type&&'event'===h?void c.data.reduce(function(a,b){'location'!==b.type&&(b.location=a)},a):a}).map(function(b){-1<['info','redirection','identifiers','branding'].indexOf(b.type)?(!a[b.type]||a[b.type].timestamp<b.timestamp)&&(a[b.type]=b):a.events.push(b)}),a},{events:[]})},h=function(a){var b='';for(var c in a)''!=b&&(b+='&'),b+=c+'='+encodeURIComponent(a[c]);return b},i=function(a){if(function(a){return'object'==typeof a&&!Array.isArray(a)}(a)){var b=Object.keys(a).sort().map(function(b){return'"'+b+'":'+i(a[b])}).join(',');return'{'+b+'}'}if(function(a){return Array.isArray(a)}(a)){var c=a.map(function(a){return i(a)}).join(',');return'['+c+']'}return function(a){return'string'==typeof a}(a)?'"'+a+'"':a.toString()},j=function(a){var b=String.fromCharCode;a=a.replace(/\r\n/g,'\n');for(var d,e='',f=0;f<a.length;f++)d=a.charCodeAt(f),128>d?e+=b(d):127<d&&2048>d?(e+=b(192|d>>6),e+=b(128|63&d)):(e+=b(224|d>>12),e+=b(128|63&d>>6),e+=b(128|63&d));return e},k=function(a){var b,c,d,e,f,g,h,k='',l=0;for(a=j(a);l<a.length;)b=a.charCodeAt(l++),c=a.charCodeAt(l++),d=a.charCodeAt(l++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),k=k+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(e)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(f)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(g)+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='.charAt(h);return k},l=function(a){try{return a.content.idData.accessLevel}catch(a){return 0}},m=function(a){this._settings=a,this._request=new d(this._settings)};m.prototype.getAssetById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},m.prototype.getAssets=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('assets?'+h(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},m.prototype.createAsset=function(a){var b=this;return new Promise(function(c,d){b._request.postRequest('assets',a).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var n=function(a){this._settings=a,this._request=new d(this._settings)};n.prototype.getEventById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},n.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('events?'+h(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})},n.prototype.createEvent=function(a,b){var c=this;return new Promise(function(d,e){c._request.postRequest('assets/'+a+'/events',b).then(function(a){return d(a)}).catch(function(a){return e(a)})})},n.prototype.getBundleById=function(a){var b=this;return new Promise(function(c,d){b._request.getRequest('bundle/'+encodeURIComponent(a)).then(function(a){return c(a)}).catch(function(a){return d(a)})})};var o=0,p=function(a){var b=this;for(var c in this._settings={apiEndpoint:'https://gateway-test.ambrosus.com'},this.events={},this.empty=[],a)a.hasOwnProperty(c)&&(b._settings[c]=a[c]);this._settings.Web3&&this._settings.secret?(this.web3=new this._settings.Web3,this.web3.version.api?console.log('Old version of web3 is not supported, Please import v1.0.0+'):(this._settings.address=this.getAddress(this._settings.secret),this._settings.token=this.getToken(this._settings.secret))):this._settings.Web3&&(this.web3=new this._settings.Web3),this._assets=new m(this._settings),this._events=new n(this._settings)};return p.prototype.getToken=function(a){if(!this.web3)return b('web3.js Library is required generate the token');var c={createdBy:this.getAddress(a),validUntil:1546300800};return k(i({signature:this.sign(c,a),idData:c}))},p.prototype.getAddress=function(a){return this.web3?this.web3.eth.accounts.privateKeyToAccount(a).address:b('web3.js Library is required get the address')},p.prototype.sign=function(a,c){return this.web3?this.web3.eth.accounts.sign(i(a),c).signature:b('web3.js Library is required get the signature')},p.prototype.getAssetById=function(a){var c=this;return new Promise(function(d,e){return a?c._assets.getAssetById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(b('Asset ID is missing.'))})},p.prototype.getEventById=function(a){var c=this;return new Promise(function(d,e){return a?c._events.getEventById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(b('Event ID is missing.'))})},p.prototype.getAssets=function(a){var b=this;return void 0===a&&(a={}),new Promise(function(c,d){return b._assets.getAssets(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},p.prototype.getEvents=function(a){var b=this;return new Promise(function(c,d){return b._events.getEvents(a).then(function(a){return c(a)}).catch(function(a){return d(a)})})},p.prototype.createAsset=function(a){var c=this;return void 0===a&&(a={}),new Promise(function(d,e){var g={};if(!c.web3)return e(b('web3.js library is required to create an asset'));if(!c._settings.secret)return e(b('Secret missing: Please initialize the SDK with your secret key'));g={timestamp:f(event),sequenceNumber:o=(o+1)%1e6,createdBy:c._settings.address},a&&a.content&&a.content.data&&(g.dataHash=c.web3.eth.accounts.hashMessage(i(a.content.data)));var h={content:{idData:g,signature:c.sign(g,c._settings.secret)}};return h.content&&h.content.idData&&h.content.idData.dataHash&&(h.content.data=a.content.data),c._assets.createAsset(h).then(function(b){return 1<=a.length?void(a.map(function(a){return c.createEvent(b.data.assetId,a).then(function(a){return d(a)}).catch(function(a){return e(a)})}),c.emit('asset:created'),d(b)):(c.emit('asset:created'),void d(b))}).catch(function(a){return e(a)})})},p.prototype.createEvent=function(a,c){var d=this;return new Promise(function(e,g){if(!d.web3)return g(b('web3.js library is required to create an event'));if(!d._settings.secret)return g(b('Secret missing: Please initialize the SDK with your secret key'));if(!a)return g(b('Asset ID is missing.'));if(!c)return g(b('Event data is missing.'));var h={};if(c.content&&c.content.data){var j={assetId:a,timestamp:f(c),accessLevel:l(c),createdBy:d._settings.address,dataHash:d.web3.eth.accounts.hashMessage(i(c.content.data))};h={content:{idData:j,signature:d.sign(j,d._settings.secret),data:c.content.data}}}else return g(b('Invalid data: No content found at content.data.'));return d._events.createEvent(a,h).then(function(a){d.emit('event:created'),e(a)}).catch(function(a){return g(a)})})},p.prototype.parseEvents=function(a){return new Promise(function(d,e){return a&&a.results?d(c(g(a))):e(b('Results array is missing.'))})},p.prototype.getBundleById=function(a){var c=this;return new Promise(function(d,e){return a?c._events.getBundleById(a).then(function(a){return d(a)}).catch(function(a){return e(a)}):e(b('Bundle ID is missing.'))})},p.prototype.on=function(a,b,c){return(this.events[a]=this.events[a]||[]).push([b,c]),this},p.prototype.off=function(a,b){a||(this.events={});for(var c=this.events[a]||this.empty,d=c.length=b?c.length:0;d--;)b===c[d][0]&&c.splice(d,1);return this},p.prototype.emit=function(a){for(var b,c=arguments,d=this,f=this.events[a]||this.empty,e=0<f.length?f.slice(0,f.length):f,g=0;b=e[g++];)b[0].apply(b[1],d.empty.slice.call(c,1));return this},p}();
//# sourceMappingURL=ambrosus.min.js.map
